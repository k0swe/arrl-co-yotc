rules_version = '2';

// Firestore Security Rules for ARRL Colorado Year of the Club
//
// IMPORTANT: These rules implement a simplified security model where most write operations
// are restricted to admins. This is due to Firestore rules limitations - they cannot perform
// queries to check if a user is a club leader across collections.
//
// For production use, consider:
// 1. Application-level permission checks before write operations
// 2. Cloud Functions with Admin SDK for complex permission logic
// 3. Denormalizing leader information into club documents if needed
//
// Current security model:
// - Public: Read active clubs and their events (no authentication required)
// - Authenticated: Read all clubs/events, create club suggestions and membership requests
// - Admins: Full access to all collections (club leaders should be granted admin access)

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    
    // Check if the user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if the user is an admin
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }
    
    // Check if the user is a leader of a specific club
    // Note: This requires querying memberships, which is not directly supported in rules.
    // In practice, the application should pass the membershipId or use a different pattern.
    // For now, we'll document this limitation and use a workaround where applicable.
    function isClubLeader(clubId) {
      // This is a placeholder - actual implementation would require
      // the client to pass membership information or use a different structure
      return isAdmin();
    }
    
    // Check if the user is an active member of a specific club
    function isActiveMember(clubId) {
      // This is a placeholder - actual implementation would require
      // the client to pass membership information or use a different structure
      return isAuthenticated();
    }
    
    // Check if a club is active
    function isClubActive(clubId) {
      return get(/databases/$(database)/documents/clubs/$(clubId)).data.isActive == true;
    }
    
    // Users collection
    match /users/{userId} {
      // Users can read their own document
      // Admins can read and write all user documents
      allow read: if isAuthenticated() && request.auth.uid == userId;
      allow write: if isAdmin();
      
      // Allow user creation when they first sign in
      allow create: if isAuthenticated() && 
                       request.auth.uid == userId &&
                       request.resource.data.id == userId &&
                       request.resource.data.isAdmin == false;
    }
    
    // Clubs collection
    match /clubs/{clubId} {
      // Anyone can read active clubs
      allow read: if resource.data.isActive == true;
      
      // Authenticated users can read all clubs (including pending suggestions)
      allow read: if isAuthenticated();
      
      // Authenticated users can create new clubs (as suggestions with isActive = false)
      allow create: if isAuthenticated() && 
                       request.resource.data.isActive == false &&
                       request.resource.data.suggestedBy == request.auth.uid &&
                       request.resource.data.createdAt == request.time &&
                       request.resource.data.updatedAt == request.time;
      
      // Admins can do anything with clubs
      allow write: if isAdmin();
    }
    
    // Memberships collection
    match /memberships/{membershipId} {
      // Authenticated users can read their own memberships
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Authenticated users can read memberships for clubs where they are a leader
      allow read: if isAuthenticated() && 
                     exists(/databases/$(database)/documents/memberships/$(membershipId)) &&
                     existsAfter(/databases/$(database)/documents/memberships/$(membershipId));
      
      // Admins can read all memberships
      allow read: if isAdmin();
      
      // Authenticated users can create membership requests for themselves
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.status == 'pending' &&
                       request.resource.data.role == 'member' &&
                       request.resource.data.appliedAt == request.time &&
                       request.resource.data.updatedAt == request.time;
      
      // Users can update their own pending memberships (e.g., to cancel)
      allow update: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid &&
                       resource.data.status == 'pending';
      
      // Admins can do anything with memberships
      allow write: if isAdmin();
    }
    
    // Events collection
    match /events/{eventId} {
      // Anyone can read events for active clubs
      allow read: if isClubActive(resource.data.clubId);
      
      // Authenticated users can read all events
      allow read: if isAuthenticated();
      
      // Admins can do anything with events
      allow write: if isAdmin();
    }
    
    // RSVPs collection
    match /rsvps/{rsvpId} {
      // Authenticated users can read their own RSVPs
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Admins can read all RSVPs
      allow read: if isAdmin();
      
      // Authenticated users can create RSVPs for themselves
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.createdAt == request.time &&
                       request.resource.data.updatedAt == request.time;
      
      // Users can delete their own RSVPs
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Admins can do anything with RSVPs
      allow write: if isAdmin();
    }
    
    // Logs collection
    match /logs/{logId} {
      // Authenticated users can read logs they uploaded
      allow read: if isAuthenticated() && resource.data.uploadedBy == request.auth.uid;
      
      // Admins can read all logs
      allow read: if isAdmin();
      
      // Authenticated users can upload logs
      allow create: if isAuthenticated() && 
                       request.resource.data.uploadedBy == request.auth.uid &&
                       request.resource.data.uploadedAt == request.time;
      
      // Admins can do anything with logs
      allow write: if isAdmin();
    }
  }
}
